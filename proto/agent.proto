syntax = "proto3";

package agent;

option go_package = "techulus/cloud-agent/internal/proto";

service AgentService {
  rpc Connect(stream AgentMessage) returns (stream ControlPlaneMessage);
}

message AgentMessage {
  string server_id = 1;
  string timestamp = 2;
  string signature = 3;
  uint64 sequence = 4;

  oneof payload {
    StatusUpdate status_update = 10;
    WorkComplete work_complete = 11;
    Heartbeat heartbeat = 12;
  }
}

message ControlPlaneMessage {
  uint64 sequence = 1;

  oneof payload {
    WorkItem work = 10;
    Acknowledgement ack = 11;
    Error error = 12;
    ConnectionAccepted connected = 13;
    CaddyConfig caddy_config = 14;
  }
}

message CaddyConfig {
  repeated CaddyRoute routes = 1;
}

message CaddyRoute {
  string id = 1;
  string domain = 2;
  repeated string upstreams = 3;
  bool internal = 4;
}

message StatusUpdate {
  Resources resources = 1;
  string public_ip = 2;
  repeated ContainerInfo containers = 3;
  repeated ProxyRouteInfo proxy_routes = 4;
}

message Resources {
  int32 cpu_cores = 1;
  int32 memory_total_mb = 2;
  int32 disk_total_gb = 3;
}

message ContainerInfo {
  string id = 1;
  string name = 2;
  string image = 3;
  string state = 4;
  int64 created = 5;
}

message ProxyRouteInfo {
  string route_id = 1;
  string domain = 2;
  repeated string upstreams = 3;
}

message WorkItem {
  string id = 1;
  string type = 2;
  bytes payload = 3;
}

message WorkComplete {
  string work_id = 1;
  string status = 2;
  string logs = 3;
}

message Heartbeat {
  int64 timestamp = 1;
}

message Acknowledgement {
  string message_id = 1;
  bool success = 2;
}

message Error {
  int32 code = 1;
  string message = 2;
  bool fatal = 3;
}

message ConnectionAccepted {
  string session_id = 1;
}
